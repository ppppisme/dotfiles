<?php
/**
 * @file
 * Functions and stuff for altered registration form.
 */

/**
 * Check if user is above minimum age limit for this site.
 */
function above_eighteen_validate_age(&$form, &$form_state) {
  $field_value = $form_state['values']['field_birthday']['und'][0]['value'];
  $minimum_age = strval(variable_get('above_eighteen_minimum_age'));

  try {
    $date_of_birth = new DateTime($field_value);
  }
  catch (Exception $exception) {
    return NULL;
  }

  $today = new DateTime();

  if ($today < $date_of_birth) {
    form_set_error('above_eightee', t('You were not born yet. Please be born before visiting this site.'));
    return NULL;
  }

  $years_old = $today->diff($date_of_birth)->y;

  if ($years_old < $minimum_age) {
    $default_error_msg = t('You are below minimum age for this site, so you are not allowed to register here.');
    $error_msg = variable_get('above_eighteen_error_message', $default_error_msg);

    form_set_error('above_eighteen', t("@error", array('@error' => $error_msg)));
  }
}
